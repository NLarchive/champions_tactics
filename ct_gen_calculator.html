<!DOCTYPE html>
<html>
<head>
    <title>Gene Stats Calculator</title>
    <style>
        body {
            font-family: sans-serif;
        }
        table {
            border-collapse: collapse;
            width: 100%;
        }
        th, td {
            border: 1px solid black;
            padding: 8px;
            text-align: left;
        }
        .gene-option {
            display: block;
            padding: 5px;
            margin: 2px 0;
            cursor: pointer;
        }
        .gene-option.selected {
            background-color: #e0e0e0;
        }
        .gene-list {
            border: 1px solid #ccc;
            height: 200px;
            overflow-y: auto;
            padding: 5px;
        }
    </style>
</head>
<body>

<h1>Gene Stats Calculator</h1>
<p>Select one gene per category (quirk only if had it):</p>

<div style="display: flex;">
    <div style="width: 33.33%;">
        <h2>DOMINANTS GENS</h2>
        <div>
            <label for="file1-category">Category:</label>
            <select id="file1-category">
                <option value="FACTION">FACTION</option>
                <option value="JOB">JOB</option>
                <option value="ELEMENT">ELEMENT</option>
                <option value="WEAPON">WEAPON</option>
                <option value="QUIRK">QUIRK</option>
            </select>
        </div>
        <div id="file1-genes" class="gene-list"></div>
        <p>Dominants Genes: <span id="file1-selected-genes"></span></p>
    </div>
    <div style="width: 33.33%;">
        <h2>RECESSIVE GENS</h2>
        <div>
            <label for="file2-category">Category:</label>
            <select id="file2-category">
                <option value="FACTION">FACTION</option>
                <option value="JOB">JOB</option>
                <option value="ELEMENT">ELEMENT</option>
                <option value="WEAPON">WEAPON</option>
                <option value="QUIRK">QUIRK</option>
            </select>
        </div>
        <div id="file2-genes" class="gene-list"></div>
        <p>Recessive Genes: <span id="file2-selected-genes"></span></p>
    </div>
    <div style="width: 33.33%;">
        <h2>MINORS GENS</h2>
        <div>
            <label for="file3-category">Category:</label>
            <select id="file3-category">
                <option value="FACTION">FACTION</option>
                <option value="JOB">JOB</option>
                <option value="ELEMENT">ELEMENT</option>
                <option value="WEAPON">WEAPON</option>
                <option value="QUIRK">QUIRK</option>
            </select>
        </div>
        <div id="file3-genes" class="gene-list"></div>
        <p>Third Genes: <span id="file3-selected-genes"></span></p>
    </div>
</div>

<button onclick="calculateStats()">Calculate Stats</button>

<div id="results-table"></div>

<script>
    // CSV data
    const csvData1 = 
    `Gene,Vitality,Inititative,Phys. Power,Elem. Power,Phys. Resist.,Elem. Resist.,Crit. Chance,Crit. Multiplier
    # FACTION
    Corporation,8,,4,2,,,,
    Cult,,3,,,,,,
    Empire,,,2,2,,,8,16
    Guardian,4,2,,,,,,
    Kingdom,8,1,,,,,,
    Tribe,4,,4,4,,,,
    Undying,12,,,,,,,
    # JOB
    Arcanist,,2,6,8,,,4,8
    Assassin,4,3,4,4,,,,
    Barbarian,,,6,6,,,12,24
    Druid,12,2,,,20,20,,
    Duelist,8,2,4,4,,,,
    Huntsman,4,2,4,4,,,4,8
    Inquisitor,6,3,3,3,,,,
    Lord,10,,4,4,30,30,,
    Mystic,8,3,,,20,20,,
    Necromancer,4,1,4,4,20,20,,
    Paladin,16,,,,40,40,,
    Protector,18,,,,30,30,,
    Scientist,,1,7,7,,,6,12
    Shaman,12,2,,,20,20,,
    Soldier,12,2,,,20,20,,
    Sorcerer,,1,6,6,,,8,16
    Warden,10,2,,,30,30,,
    # ELEMENT
    Air,4,2,,,,,,
    Chaos,,,2,2,,,8,16
    Darkness,8,1,,,,,,
    Fire,4,,4,4,,,,
    Light,,1,2,2,,,4,8
    Nature,12,,,,,,,
    Order,4,1,2,2,,,,
    Techno,8,,2,2,,,,
    Water,8,1,,,,,,
    # WEAPON
    Blunderbuss,,,2,,,,6,5
    Crossbow,,,2,,,,6,12
    Dagger,,1,3,,,,,
    Greataxe,,,5,,,,,
    Greatsword,6,,2,,,,,
    Halberd,,,5,,,,,
    Katana,,1,3,,,,,
    Mystical horn,,,,5,,,,
    Rapier,,1,3,,,,,
    Runic scimitar,,1,3,,,,,
    Scepter,,,,5,,,,
    Sickle,,1,3,,,,,
    Spatha,,1,3,,,,,
    Spear,,,5,,,,,
    Spellbook,,,,5,,,,
    Voodoo doll,,,,5,,,,
    # QUIRK
    Agile,,2,,,,,,
    Blind,,,,4,,,,
    Corporate,8,,,,,,,
    Cult pupil,8,,,,,,,
    Cursed,,,,4,,,,
    Demon slayer,,,4,,,,,
    Desert fighter,,2,,,,,,
    Evil,,,,4,,,,
    Lucky,,,,,,,4,8
    Masked,,,,,,,4,8
    One eyed,,,4,,,,,
    Quick,,2,,,,,,
    Runic,8,,,,,,,
    Sacred,8,,,,,,,
    Strong,,,4,,,,,
    Veteran,,,4,,,,,
    Vigilante,8,,,,,,,
    Zealous,,,,4,,,,
    ;`;
    
    const csvData2 = 
    `Gene,Vitality,Inititative,Phys. Power,Elem. Power,Phys. Resist.,Elem. Resist.,Crit. Chance,Crit. Multiplier
    # FACTION
    Corporation,4,,1,,,,,
    Cult,,1,,,,,,
    Empire,,,,,,,4,8
    Guardian,,1,,,,,,
    Kingdom,4,,,,,,,
    Tribe,,,2,2,,,,
    Undying,4,,,,,,,
    # JOB
    Arcanist,,,2,3,,,,
    Assassin,,1,,,,,,
    Barbarian,,,2,2,,,,
    Druid,4,,,,,,,
    Duelist,2,,1,1,,,,
    Huntsman,,1,,,,,,
    Inquisitor,,1,,,,,,
    Lord,2,,1,1,,,,
    Mystic,,1,,,,,,
    Necromancer,,,2,2,,,,
    Paladin,4,,,,,,,
    Protector,4,,,,,,,
    Scientist,,,2,2,,,,
    Shaman,4,,,,,,,
    Soldier,4,,,,,,,
    Sorcerer,,,2,2,,,,
    Warden,4,,,,,,,
    # ELEMENT
    Air,,1,,,,,,
    Chaos,,,,,,,4,8
    Darkness,4,,,,,,,
    Fire,,,2,2,,,,
    Light,,,1,1,,,2,4
    Nature,4,,,,,,,
    Order,,1,,,,,,
    Techno,4,,,,,,,
    Water,,1,,,,,,
    # WEAPON
    Blunderbuss,,,,,,,4,8
    Crossbow,,,,,,,4,8
    Dagger,,1,,,,,,
    Greataxe,,,2,,,,,
    Greatsword,4,,,,,,,
    Halberd,,,2,,,,,
    Katana,,1,,,,,,
    Mystical horn,,,,2,,,,
    Rapier,,1,,,,,,
    Runic scimitar,,1,,,,,,
    Scepter,,,,2,,,,
    Sickle,,1,,,,,,
    Spatha,,1,,,,,,
    Spear,,,2,,,,,
    Spellbook,,,,2,,,,
    Voodoo doll,,,,2,,,,
    # QUIRK
    Agile,,1,,,,,,
    Blind,,,,2,,,,
    Corporate,4,,,,,,,
    Cult pupil,4,,,,,,,
    Cursed,,,,2,,,,
    Demon slayer,,,2,,,,,
    Desert fighter,,1,,,,,,
    Evil,,,,2,,,,
    Lucky,,,,,,,2,4
    Masked,,,,,,,2,4
    One eyed,,,2,,,,,
    Quick,,1,,,,,,
    Runic,4,,,,,,,
    Sacred,4,,,,,,,
    Strong,,,2,,,,,
    Veteran,,,2,,,,,
    Vigilante,4,,,,,,,
    Zealous,,,,2,,,,
    ;`;
    
    const csvData3 = 
    `Gene,Vitality,Inititative,Phys. Power,Elem. Power,Phys. Resist.,Elem. Resist.,Crit. Chance,Crit. Multiplier
    # FACTION
    Corporation,4,,1,,,,,
    Cult,,1,,,,,,
    Empire,,,,,,,4,8
    Guardian,,1,,,,,,
    Kingdom,4,,,,,,,
    Tribe,,,2,2,,,,
    Undying,4,,,,,,,
    # JOB
    Arcanist,,,2,3,,,,
    Assassin,,1,,,,,,
    Barbarian,,,2,2,,,,
    Druid,4,,,,,,,
    Duelist,2,,1,1,,,,
    Huntsman,,1,,,,,,
    Inquisitor,,1,,,,,,
    Lord,2,,1,1,,,,
    Mystic,,1,,,,,,
    Necromancer,,,2,2,,,,
    Paladin,4,,,,,,,
    Protector,4,,,,,,,
    Scientist,,,2,2,,,,
    Shaman,4,,,,,,,
    Soldier,4,,,,,,,
    Sorcerer,,,2,2,,,,
    Warden,4,,,,,,,
    # ELEMENT
    Air,,1,,,,,,
    Chaos,,,,,,,4,8
    Darkness,4,,,,,,,
    Fire,,,2,2,,,,
    Light,,,1,1,,,2,4
    Nature,4,,,,,,,
    Order,,1,,,,,,
    Techno,4,,,,,,,
    Water,,1,,,,,,
    # WEAPON
    Blunderbuss,,,,,,,4,8
    Crossbow,,,,,,,4,8
    Dagger,,1,,,,,,
    Greataxe,,,2,,,,,
    Greatsword,4,,,,,,,
    Halberd,,,2,,,,,
    Katana,,1,,,,,,
    Mystical horn,,,,2,,,,
    Rapier,,1,,,,,,
    Runic scimitar,,1,,,,,,
    Scepter,,,,2,,,,
    Sickle,,1,,,,,,
    Spatha,,1,,,,,,
    Spear,,,2,,,,,
    Spellbook,,,,2,,,,
    Voodoo doll,,,,2,,,,
    # QUIRK
    Agile,,1,,,,,,
    Blind,,,,2,,,,
    Corporate,4,,,,,,,
    Cult pupil,4,,,,,,,
    Cursed,,,,2,,,,
    Demon slayer,,,2,,,,,
    Desert fighter,,1,,,,,,
    Evil,,,,2,,,,
    Lucky,,,,,,,2,4
    Masked,,,,,,,2,4
    One eyed,,,2,,,,,
    Quick,,1,,,,,,
    Runic,4,,,,,,,
    Sacred,4,,,,,,,
    Strong,,,2,,,,,
    Veteran,,,2,,,,,
    Vigilante,4,,,,,,,
    Zealous,,,,2,,,,
    ;`;

   

    // Store selected genes globally
    const selectedGenes1 = [];
    const selectedGenes2 = [];
    const selectedGenes3 = []; 

    // Function to parse CSV data into an array of objects, categorized by section
    function parseCSV(csvString) {
        const lines = csvString.trim().split('\n');
        const data = {};
        let currentCategory = null;

        for (let i = 0; i < lines.length; i++) {
            const line = lines[i].trim();
            if (line.startsWith("# ")) {
                currentCategory = line.substring(2);
                data[currentCategory] = [];
            } else if (currentCategory && line && !line.startsWith("Gene,")) { // Skip header row
                const values = line.split(',');
                const obj = {};
                for (let j = 0; j < values.length; j++) {
                    // Convert empty strings to 0 for numeric columns
                    obj[j] = values[j] === '' ? 0 : values[j];
                }
                data[currentCategory].push(obj);
            }
        }
        return data;
    }

    // Function to populate gene selection
    function populateGeneSelection(fileId, category) {
        const csvData = fileId === 'file1' ? csvData1 : (fileId === 'file2' ? csvData2 : csvData3); 
        const geneList = document.getElementById(`${fileId}-genes`);
        geneList.innerHTML = ''; // Clear previous options

        const genes = parseCSV(csvData)[category].map(row => row[0]);
         
        genes.forEach((gene) => {
            const option = document.createElement('div');
            option.className = 'gene-option';
            option.textContent = gene;
            option.onclick = function() {
                this.classList.toggle('selected');
                updateSelectedGenes(fileId, category);
            };
            // Check if the gene is already selected
            const selectedGenes = fileId === 'file1' ? selectedGenes1 : (fileId === 'file2' ? selectedGenes2 : selectedGenes3); 
            if (selectedGenes[category] && selectedGenes[category].includes(gene)) {
                option.classList.add('selected');
            }
            geneList.appendChild(option);
        });
        updateSelectedGenesDisplay(fileId);
    }

    // Function to update selected genes
    function updateSelectedGenes(fileId, category) {
        const geneList = document.getElementById(`${fileId}-genes`);
        const selectedGenes = fileId === 'file1' ? selectedGenes1 : (fileId === 'file2' ? selectedGenes2 : selectedGenes3); 
        selectedGenes[category] = [];
        geneList.querySelectorAll('.gene-option.selected').forEach(option => {
            selectedGenes[category].push(option.textContent);
        });
        updateSelectedGenesDisplay(fileId);
    }

    // Event listeners for category selection 
    document.getElementById('file1-category').addEventListener('change', (event) => {
        populateGeneSelection('file1', event.target.value);
    });

    document.getElementById('file2-category').addEventListener('change', (event) => {
        populateGeneSelection('file2', event.target.value);
    });

    document.getElementById('file3-category').addEventListener('change', (event) => { 
        populateGeneSelection('file3', event.target.value);
    });

    // Function to update the displayed list of selected genes
    function updateSelectedGenesDisplay(fileId) {
        const selectedGenesSpan = document.getElementById(`${fileId}-selected-genes`);
        const selectedGenes = fileId === 'file1' ? selectedGenes1 : (fileId === 'file2' ? selectedGenes2 : selectedGenes3); 
        const allSelectedGenes = Object.values(selectedGenes).flat();
        selectedGenesSpan.textContent = allSelectedGenes.join(', ');
    }

    // Calculate and display summed stats
    function calculateStats() {
        const category1 = document.getElementById('file1-category').value;
        const category2 = document.getElementById('file2-category').value;
        const category3 = document.getElementById('file3-category').value; 

        const parsedData1 = parseCSV(csvData1);
        const parsedData2 = parseCSV(csvData2);
        const parsedData3 = parseCSV(csvData3); 

        const allSelectedGenes1 = Object.values(selectedGenes1).flat();
        const allSelectedGenes2 = Object.values(selectedGenes2).flat();
        const allSelectedGenes3 = Object.values(selectedGenes3).flat(); 

        const summedData = sumStats(allSelectedGenes1, allSelectedGenes2, allSelectedGenes3, parsedData1, parsedData2, parsedData3);

        displayResultsTable(summedData);
    }

    // Function to sum stats for selected genes (modified to handle three datasets)
    function sumStats(selectedGenes1, selectedGenes2, selectedGenes3, data1, data2, data3) { 
        const filteredData1 = Object.values(data1).flat().filter(row => selectedGenes1.includes(row[0]));
        const filteredData2 = Object.values(data2).flat().filter(row => selectedGenes2.includes(row[0]));
        const filteredData3 = Object.values(data3).flat().filter(row => selectedGenes3.includes(row[0])); 

        const mergedData = {};

        // Function to merge data from a single dataset into mergedData
        function mergeData(filteredData) {
            filteredData.forEach(row => {
                if (mergedData[row[0]]) {
                    // Sum numeric values if gene exists
                    Object.keys(row).forEach(key => {
                        if (!isNaN(parseFloat(row[key]))) {
                            mergedData[row[0]][key] = (parseFloat(mergedData[row[0]][key]) || 0) + parseFloat(row[key]);
                        }
                    });
                } else {
                    mergedData[row[0]] = { ...row }; 
                }
            });
        }

        // Merge data from all three datasets
        mergeData(filteredData1);
        mergeData(filteredData2);
        mergeData(filteredData3); 

        const resultArray = Object.values(mergedData);

        // Calculate total stats
        const totalStats = {};
        Object.keys(resultArray[0]).forEach(key => {
            if (!isNaN(parseFloat(resultArray[0][key]))) {
                totalStats[key] = resultArray.reduce((sum, row) => sum + parseFloat(row[key]), 0);
            } else {
                totalStats[key] = ''; // Set non-numeric fields to empty string
            }
        });

        // Add base stats to the total
        totalStats[1] = parseFloat(totalStats[1]) + 40; // Add 40 to Vitality
        totalStats[8] = parseFloat(totalStats[8]) + 60; // Add 60 to Crit. Multiplier

        totalStats[0] = 'Total (with base)';
        resultArray.push(totalStats);

        return resultArray;
    }

    // Function to display results in a table
    function displayResultsTable(data) {
        const resultsTable = document.getElementById('results-table');
        resultsTable.innerHTML = ''; // Clear previous table

        const table = document.createElement('table');
        const headerRow = table.insertRow();
        // Assuming the first row of data contains header names
        Object.keys(data[0]).forEach((key, index) => {
            const headerCell = headerRow.insertCell();
            // Map numeric index to header name (adjust as needed)
            const headerNames = ["Gene", "Vitality", "Initiative", "Phys. Power", "Elem. Power", "Phys. Resist.", "Elem. Resist.", "Crit. Chance", "Crit. Multiplier"];
            headerCell.textContent = headerNames[index] || key;
        });

        data.forEach(row => {
            const dataRow = table.insertRow();
            Object.values(row).forEach(value => {
                const dataCell = dataRow.insertCell();
                dataCell.textContent = value;
            });
        });

        resultsTable.appendChild(table);
    }

    // Initialize the page
    populateGeneSelection('file1', 'FACTION'); // Default to FACTION
    populateGeneSelection('file2', 'FACTION'); // Default to FACTION
    populateGeneSelection('file3', 'FACTION'); // Default to FACTION 
</script>

</body>
</html>
